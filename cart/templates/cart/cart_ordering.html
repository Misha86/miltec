{% extends "base.html" %}{% load staticfiles %}


{% block title %}
    Оформление заказа
{% endblock %}

{% block script %}

    <style>
        #map{
            height: 500px;
        }

        .close-map {
            position: absolute;
            cursor: pointer;
            z-index: 10;
            top: -12.5px;
            right: -12.5px;
            display: block;
            width: 30px;
            height: 30px;
            text-indent: -9999px;
            background: url("data:image/png;base64,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") no-repeat 0 0;
        }
    </style>

    <script type="text/javascript">

        var map;
        var service;
        var infowindow;

        function addMarker(place) {
            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                icon: {
                    url: '{% static 'img/np-marker.png' %}',
                    anchor: new google.maps.Point(10, 10),
                    scaledSize: new google.maps.Size(20, 34)
                },
                title: place.name + ' \n' + place.vicinity
            });

            // marker for new post
            google.maps.event.addListener(marker, 'click', function() {
                service.getDetails({
                    placeId: place.place_id
                }, function(result, status) {
                    if (status !== google.maps.places.PlacesServiceStatus.OK) {
                        console.error(status);
                        return;
                    }

                    $('input#id_address').val(result.name + ' ' + result.formatted_address);

                    map.setZoom(15);
                    map.setCenter(marker.getPosition());

                    infowindow.setContent('<div><strong>' + result.name + '</strong><br>' +
                    '<br>' + result.formatted_address + '</div>');
                    infowindow.open(map, marker);
                });
            });
        }

        function callback(places, status) {
            {#            console.log(places);#}
            if (status == google.maps.places.PlacesServiceStatus.OK) {
                for(var i=0; i < places.length; i++){
                    addMarker(places[i]);
                }
            }
        }

        function performSearch (){
            var request = {
                bounds: map.getBounds(),
                name: 'новая почта'
            };
            service.nearbySearch(request, callback);
        }

        function initialise (location){
            {#            console.log(location);#}
            var myLatLng = {lat: location.coords.latitude, lng: location.coords.longitude};
            var mapOptions = {
                center: myLatLng,
                zoom: 12
            };

            map = new google.maps.Map(document.getElementById('map'), mapOptions);

            var marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                title: 'Моя локация'
            });

            // add close buttton
            var closeButton = document.createElement('div');
            closeButton.text = 'Close';
            $(closeButton).addClass('close-map');
            $(closeButton).click(function(){
                $('#map').hide();
                $('body').scrollTop(0)
            });

            map.controls[google.maps.ControlPosition.RIGHT_TOP].push(closeButton);

            // marker my location
            marker.addListener('click', function() {
                map.setZoom(15);
                {#                console.log(this.title);#}
                map.setCenter(this.getPosition());
            });

            infowindow = new google.maps.InfoWindow();
            service = new google.maps.places.PlacesService(map);

            google.maps.event.addListener(map, 'bounds_changed', performSearch);

        }

        $(function(){

            $("input#id_address").click(function() {

                var map = $('#map');
                map.show();

                navigator.geolocation.getCurrentPosition(initialise);

                $('html, body').animate({
                    scrollTop: map.offset().top - 20
                }, 1000);

            });

        })

    </script>

    <link href="{% static 'css/cart.css' %}" rel="stylesheet" type="text/css">
    <script src="{% static 'js/cart.js' %}"></script>

    <script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyCCGuxN6OjpeVdH6rFh2AABSTV_-ahgr9U&libraries=places'></script>

{#    <script src="{% static 'js/jquery.modal.js' %}"></script>#}
    <link href="{% static 'css/register.css' %}" rel="stylesheet" type="text/css">
{#    <link rel="stylesheet" href="{% static 'css/jquery.modal.css' %}"/>#}

    {{ form.media }}

{% endblock %}

{% block cart %}

    <div class="boxen">

        <div id="ordering" class="my-shop box" style="margin-bottom: 15em;">

            <div class="forms">

                <div class="form-title">
                    <h3>Оформление заказа</h3>
                </div>

                <form class="register yform" method="post" action="">

                    {% csrf_token %}

                    {% for field in form %}

                        {% if field.errors %}
                            <div class="form-group has-error">

                                {% for error in field.errors %}

                                    <label class="control-label errorlist">
                                        <em>{{ error }}</em>
                                    </label>

                                {% endfor %}

                            </div>
                        {% endif %}

                        <div class="type-text">

                            {{ field.label_tag }}

                            {{ field }}

                            {% if field.help_text %}
                                <p class="help">{{ field.help_text|safe }}</p>
                            {% endif %}

                        </div>

                    {% endfor %}

                    <div class="clearfix cart-total">
                         <span class="cart-return-link">
                             <span class="btn-link btn-link-gray">
                                 <a href="{% url 'menu:homepage' %}" class="btn-link-i" name="close">ВЕРНУТЬСЯ НАЗАД</a>
                             </span>
                         </span>
                        <span class="cart-submit">
                             <span class="btn-link-green btn-link">
                                 <button class="btn-link-i" id="popup-checkout" type="submit">ОТПРАВИТЬ</button>
                             </span>
                         </span>
                    </div>
                </form>

            </div>

            <div id="ordering-list">
                <div class="widget" role="actions">

                    <h2>Список товаров</h2>

                    <div class="cart-ordering">

                        <table class="cart">
                            <tbody>
                            {% for item in cart %}
                                {% with product=item.product %}
                                    <tr id="cart-product-{{ product.id }}-{{ item.size }}">
                                        <td>
                                            <a href="{{ product.get_absolute_url }}">
                                                <img src="{{ product.image.url }}" alt="{{ product.title }}"/>
                                            </a>
                                        </td>
                                        <td>{{ product.title }}</td>
                                        <td>{{ item.quantity }}шт.</td>
                                        <td class="num">{{ item.total_price }} EUR*</td>
                                    </tr>
                                {% endwith %}
                            {% endfor %}
                            <tr class="total">
                                <td colspan="2">Всего</td>
                                <td colspan="2" id="total_price" class="num">{{ cart.get_total_price }} EUR*</td>
                            </tr>
                            <tr>
                                <td colspan="4">
                                    <div class="aligned-center">
                                        <a class="check-edit-order-link"  href="{% url 'cart:detail' %}" name="edit" >
                                            Редактировать заказ
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="widgetBottom"></div>
                </div>
            </div>

        </div>

        <div id="map" class="my-shop box" hidden="hidden"></div>

    </div>

    {#    <link rel='stylesheet' href='https://apimgmtstorelinmtekiynqw.blob.core.windows.net/content/MediaLibrary/Widget/Map/styles/map.css' />#}
    {#    <div id="np-map"> <button type="button" id="npw-map-open-button">НАЙБЛИЖЧЕ ВІДДІЛЕННЯ</button> <script async="" defer="" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPhm7Q29X5ldwjLtA7IMYHU_0xATiWK3A"></script> </div>#}
    {#    <script type='text/javascript' src='https://apimgmtstorelinmtekiynqw.blob.core.windows.net/content/MediaLibrary/Widget/Map/dist/map.min.js'></script>#}

{% endblock %}